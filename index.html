<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <script>

        var app = angular.module('rejillaApp', []);
        app.controller('rejillaCtrl', function($scope) 
        {
            let randomIntFromInterval = ((min, max) =>
            { 	// min and max included 
                return Math.floor(Math.random() * (max - min + 1) + min)
            });

            /**
             * Función que genera aleatoriamente operaciones
             */
            let getOperationValue = ((minValue, maxValue, numValues, maxTotal) => 
            {
                let returnObj = null;

                // Calcula los valores y operadores
                if(numValues >= 2)
                {
                    returnObj = {};
                    returnObj.values = [];
                    for(let i=0; i<numValues; i++)
                    {
                        returnObj.values.push(randomIntFromInterval(minValue, maxValue));
                    }
                     
                    returnObj.operators = [];
                    for(let i=0; i<numValues-1; i++)
                    {
                        returnObj.operators.push(randomIntFromInterval(0, 1)? "+" : "-");
                    }

                    let totalValue = 0;
                    // Realiza la operación
                    for(let i=0; i < returnObj.values.length; i++)
                    {
                        if(i==0)
                        { totalValue = Number(returnObj.values[i]); }
                        else
                        {
                            if(returnObj.operators[i-1] == "+")
                                totalValue += Number(returnObj.values[i]);
                            else if(returnObj.operators[i-1] == "-")
                                totalValue -= Number(returnObj.values[i]);
                        }
                    }
                    returnObj.total = totalValue;
                }

                return returnObj;
            });

            /**
             * Función que valida que los valores calculados cumplen las necesidades
             */ 
            let validaOperationValues = ((operationValues, maxTotal) =>
            {
                let resultValid = true;

                if(operationValues &&
                   operationValues.total &&
                   Number(operationValues.total) <= maxTotal &&
                   Number(operationValues.total) >= 0)
                {
                    let totalValue = 0;
                    // Realiza la operación
                    for(let i=0; i < operationValues.values.length && resultValid; i++)
                    {
                        if(i==0)
                        { totalValue = Number(operationValues.values[i]); }
                        else
                        {
                            if(operationValues.operators[i-1] == "+")
                                totalValue += Number(operationValues.values[i]);
                            else if(operationValues.operators[i-1] == "-")
                                totalValue -= Number(operationValues.values[i]);
                        }

                        if(totalValue < 0)
                            resultValid = false;
                    }
                }
                else
                    resultValid = false;

                return resultValid;
            });

            /**
             * Función que corrige el resultado obtenido tras realizar los cálculos
             */ 
            $scope.validaResultado = (() =>
            {
                let isOK = false;
                let finalMessage = "";

                let result = $scope.result;

                if(result &&
                   result.line)
                {
                    let lines = result.line.filter(l => (l != null && l.length > 0));

                    if(lines && lines.length > 0)
                    {
                        let line = lines[lines.length-1];
                        let resultFinal = line.filter(l => (l != null && l != 0));

                        if(resultFinal && 
                        resultFinal.length == 1 &&
                        resultFinal[0] == operationValues.total)
                        {
                            isOK = true;
                            finalMessage = "Resultado correcto!!!";
                        }
                        else
                        {
                            finalMessage = "Algo has hecho mal!!! Revísalo";
                        }
                    }
                    else
                    {
                        finalMessage = "Primero debes realizar la operación";
                    }
                }
                else
                {
                    finalMessage = "Primero debes realizar la operación";
                }

                $scope.resultadoOperacion = { isOK: isOK,
                                              finalMessage: finalMessage };
            });

            
            $scope.result = { line: []};
            $scope.numLines = 5;

            for(let i= 0; i < $scope.numLines; i++)
            {   $scope.result.line[i] = []; }

            let minValue = 1;
            let maxValue = 400;
            let maxTotal = 999

            let operationValues = null;

            do
            {
                operationValues = getOperationValue(minValue, maxValue, 3, maxTotal);

            }
            while (!validaOperationValues(operationValues, maxTotal));
            


            $scope.valor1 = operationValues.values[0];
            $scope.valor2 = operationValues.values[1];
            $scope.valor3 = operationValues.values[2];

            $scope.operador1 = operationValues.operators[0];
            $scope.operador2 = operationValues.operators[1];
        });

    </script>

    <title>Rejillas</title>

    <style>

        textarea:hover, 
        input:hover, 
        textarea:active, 
        input:active, 
        textarea:focus, 
        input:focus,
        button:focus,
        button:active,
        button:hover,
        label:focus,
        .btn:active,
        .btn.active
        {
            outline:0px !important;
            -webkit-appearance:none;
            box-shadow: none !important;
        }

    </style>


  </head>
  <body>
    <div class="container p-5" ng-app="rejillaApp" ng-controller="rejillaCtrl">
        
        <div class="row text-center">

            <div class="col-3 border-end border-primary"></div>
            <div class="col border-start-0 border-bottom-0 border border-primary fs-3 rounded-top rounded-2">
                <div class="container">
                    <div class="row">
                        <div class="col border-0 ">{{valor1}}</div>
                        <div class="col border-0">{{operador1}}</div>
                        <div class="col border-0">{{valor2}}</div>
                        <div class="col border-0">{{operador2}}</div>
                        <div class="col border-0">{{valor3}}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row text-center" ng-repeat="line in [].constructor(numLines) track by $index">

            <div class="col-3 border border-primary" ng-class="{'border-top-0':  $index != 0 }">
                <input type="number" class="form-control form-control-lg border-0 text-center" id="operacion1" data-bind="value:replyNumber">
            </div>
            <div class="col-3 border border-start-0 border-start-0 border-primary" ng-class="{'border-top-0':  $index != 0 }">
                <input type="number" class="form-control form-control-lg border-0 text-center" id="operacion1" ng-model="result.line[$index][0]" data-bind="value:replyNumber">
            </div>
            <div class="col-3 border border-start-0 border-primary" ng-class="{'border-top-0':  $index != 0 }">
                <input type="number" class="form-control form-control-lg border-0 text-center" id="operacion1" ng-model="result.line[$index][1]" data-bind="value:replyNumber">
            </div>
            <div class="col-3 border border-start-0 border-primary" ng-class="{'border-top-0':  $index != 0 }">
                <input type="number" class="form-control form-control-lg border-0 text-center" id="operacion1" ng-model="result.line[$index][2]" data-bind="value:replyNumber">
            </div>
            
        </div>


        <div class="row text-center pt-2">

            <p class="text-white" ng-class="(resultadoOperacion.isOK)?'bg-success' : 'bg-danger'">{{resultadoOperacion.finalMessage}} </p>

        </div>

        <div class="row text-center">

            <button type="button" class="btn btn-primary" ng-click="validaResultado()">Comprobar</button>

        </div>

    </div>
    
  </body>
</html>